Wenn du viele Server hast, die denselben Cron Job ausführen, ist es gewöhnlich eine gute Idee, sie nicht alle zur gleichen Zeit zu führen. Wenn alle Aufträge auf einen gemeinsamen Server zugreifen (z. B. beim Ausführen von Backups), kann es zu viel auf diesen Server geladen werden, und selbst wenn sie es nicht tun, werden alle Server gleichzeitig beschäftigt sein, was sie beeinflussen kann Fähigkeit, andere Dienstleistungen zu erbringen.

Wie üblich kann die Marionette helfen; Dieses Mal, mit der inline_template-Funktion, um eine eindeutige Zeit für jeden Job zu berechnen.

### Wie es geht...

Hier ist, wie man Puppet Zeitplan den gleichen Job zu einem anderen Zeitpunkt für jede Maschine haben:

1. Ändern Sie Ihre `site.pp` Datei wie folgt:
```
node 'cookbook' {
  cron { 'run-backup':
    ensure  => present,
    command => '/usr/local/bin/backup',
    hour    => inline_template('<%= @hostname.sum % 24 %>'),
    minute  => '00',
  }
}
```

2. Puppet run:
```
[root@cookbook ~]# puppet agent -t
Info: Caching catalog for cookbook.example.com
Info: Applying configuration version '1413730771'
Notice: /Stage[main]/Main/Node[cookbook]/Cron[run-backup]/ensure: created
Notice: Finished catalog run in 0.11 seconds
```

3. Führen Sie `crontab´ aus, um zu sehen, wie der Job konfiguriert wurde:
```
[root@cookbook ~]# crontab -l
# HEADER: This file was autogenerated at Sun Oct 19 10:59:32 -0400 2014 by puppet.
# HEADER: While it can still be managed manually, it is definitely not recommended.
# HEADER: Note particularly that the comments starting with 'Puppet Name' should
# HEADER: not be deleted, as doing so could cause duplicate cron jobs.
# Puppet Name: run-backup
0 15 * * * /usr/local/bin/backup
```

### Wie es funktioniert...

Wir wollen die Stunde des Cron-Jobs über alle unsere Knoten verteilen. Wir wählen etwas, das über alle Maschinen einzigartig ist und es in eine Zahl umwandelt. Auf diese Weise wird der Wert über die Knoten verteilt und wird sich nicht pro Knoten ändern.

Wir können die Umwandlung mit Rubys `sum` methode durchführen, die einen numerischen Wert aus einer Zeichenkette berechnet, die für die Maschine eindeutig ist (in diesem Fall der Hostname des Rechners). Die Summenfunktion erzeugt eine große Ganzzahl (im Fall des String-Kochbuchs ist die Summe 855), und wir wollen Werte für Stunden zwischen 0 und 23, also verwenden wir Rubys% (modulo) Operator, um das Ergebnis auf diesen Bereich zu beschränken . Wir sollten eine vernünftig gute (wenn auch nicht statistisch einheitliche) Verteilung der Werte erhalten, abhängig von Ihren Hostnamen. Eine weitere Möglichkeit ist hier, die Funktion fqdn_rand () zu verwenden, die in ähnlicher Weise funktioniert wie unser Beispiel.

Wenn alle deine Maschinen den gleichen Namen haben (es passiert), erwarte nicht diesen Trick zu arbeiten! In diesem Fall können Sie einen anderen String verwenden, der für die Maschine eindeutig ist, z. B. ipaddress oder fqdn.
Es gibt mehr...

Wenn Sie mehrere Cron-Jobs pro Maschine haben und Sie eine bestimmte Anzahl von Stunden auseinander ausführen möchten, fügen Sie diese Nummer der Hostname.sum-Ressource hinzu, bevor Sie den Modul nehmen. Nehmen wir an, wir wollen den Job dump_database zu irgendeinem beliebigen Zeitpunkt und den Run_backup Job eine Stunde später ausführen, dies kann mit dem folgenden Code-Snippet erfolgen: